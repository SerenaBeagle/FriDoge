<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FriDoge Demo</title>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --pink: #F6C1CC;
      --brown: #6B4F3F;
      --yellow: #F4D06F;
      --cream: #FFF7ED;
      --card: #FFFFFF;
      --line: #EAD7CB;
      --shadow: rgba(107, 79, 63, 0.18);
    }

    * { box-sizing: border-box; font-family: 'Nunito', sans-serif; }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(180deg, #FBE4E9, #FFF7ED);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 18px;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }

    /* ===== Outer shell becomes responsive ===== */
    .shell {
      width: 100%;
      max-width: 980px; /* desktop can be wider now */
    }

    .app {
      width: 100%;
      background: var(--card);
      border-radius: 26px;
      padding: 22px;
      box-shadow: 0 18px 40px var(--shadow);
      position: relative;
      overflow: hidden;
    }

    /* ===== Language Toggle ===== */
    .lang-toggle {
      position: absolute;
      top: 14px;
      right: 16px;
      background: #FFF;
      border: 2px solid var(--line);
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      font-size: 12px;
      user-select: none;
      z-index: 5;
    }
    .lang-toggle span {
      padding: 6px 10px;
      cursor: pointer;
      color: var(--brown);
    }
    .lang-toggle .active {
      background: var(--yellow);
      font-weight: 700;
    }

    .header { text-align: center; margin-top: 12px; margin-bottom: 10px; }
    .header h1 { margin: 0; font-size: 28px; color: var(--brown); letter-spacing: -0.3px; }
    .header p { margin-top: 6px; font-size: 14px; color: #8A6E5A; }

    /* Enter contents*/
    .pill {
      margin: 14px auto 0;
      width: fit-content;
      background: #FFF8DC;
      border: 1px dashed #E4C9A8;
      color: #6B4F3F;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
    }

    /* ===== Main layout: mobile 1-col, desktop 2-col ===== */
    .layout {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    /* Buttons*/
    .panel {
      background: rgba(255, 247, 237, 0.35);
      border: 1px solid rgba(234, 215, 203, 0.8);
      border-radius: 20px;
      padding: 14px;
    }

    .section { margin-top: 14px; }
    .section:first-child { margin-top: 0; }

    label {
      display: block;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--brown);
    }

    textarea, select, input {
      width: 100%;
      border-radius: 16px;
      padding: 11px 12px;
      border: 2px solid var(--line);
      background: var(--cream);
      font-size: 14px;
      color: #4A372D;
      outline: none;
    }

    textarea { resize: none; }

    textarea:focus, select:focus, input:focus {
      border-color: var(--pink);
      background: #FFF;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .hint {
      margin-top: 6px;
      font-size: 12px;
      color: #9C7C6A;
    }

    .button-wrapper { margin-top: 16px; text-align: center; }

    button {
      width: 100%;
      max-width: 360px;
      background: var(--yellow);
      color: var(--brown);
      border: none;
      border-radius: 999px;
      padding: 13px 22px;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(244, 208, 111, 0.55);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 14px 28px rgba(244, 208, 111, 0.65); }
    button:active { transform: translateY(0px); }

    /* ===== Reaction panel ===== */
    .reaction-wrap {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .reaction-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .reaction-title h3 {
      margin: 0;
      font-size: 14px;
      color: var(--brown);
      font-weight: 800;
      letter-spacing: -0.2px;
    }

    .mini-btns {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .mini-btn {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--brown);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .mini-btn:hover { filter: brightness(0.98); }

    .reaction {
      background: #FFF8DC;
      border-radius: 18px;
      padding: 14px 16px;
      min-height: 140px;
      font-size: 14px;
      line-height: 1.65;
      white-space: pre-wrap;
      color: #5A4033;
      border: 1px solid rgba(228, 201, 168, 0.8);
    }
    .reaction.loading { opacity: 0.75; font-style: italic; }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: #A18673;
      text-align: center;
    }

    /* ===== Desktop enhancements ===== */
    @media (min-width: 860px) {
      body { padding: 24px; padding-bottom: calc(24px + env(safe-area-inset-bottom)); }
      .app { padding: 26px; }
      .header h1 { font-size: 32px; }
      .layout {
        grid-template-columns: 1.05fr 0.95fr; /* left: inputs, right: result */
        gap: 18px;
        align-items: start;
      }
      .panel { padding: 18px; border-radius: 22px; }

      /* Sticky result on desktop for nice UX */
      .right-panel {
        position: sticky;
        top: 18px;
      }

      /* Make reaction scroll inside the right panel */
      .reaction {
        min-height: 520px;
        max-height: 62vh;
        overflow: auto;
      }
    }

    /* ===== Small phones ===== */
    @media (max-width: 380px) {
      .grid-2 { grid-template-columns: 1fr; }
      .lang-toggle { top: 10px; right: 10px; }
      .header h1 { font-size: 26px; }
    }


    /* ===== Items table ===== */
    .items-toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .items-table {
      border: 1px solid rgba(234, 215, 203, 0.8);
      border-radius: 16px;
      overflow: hidden;
      background: rgba(255, 247, 237, 0.35);
    }

    .items-header, .item-row {
      display: grid;
      grid-template-columns: 1.2fr 0.9fr 0.9fr 1fr 1fr 1fr 0.7fr 40px;
      gap: 8px;
      padding: 10px;
      align-items: center;
    }

    .items-header {
      background: #FFF;
      border-bottom: 1px solid rgba(234, 215, 203, 0.8);
      font-size: 12px;
      font-weight: 800;
      color: var(--brown);
    }

    .item-row {
      border-bottom: 1px solid rgba(234, 215, 203, 0.5);
    }

    .item-row:last-child {
      border-bottom: none;
    }

    .item-row input {
      padding: 10px 10px;
      border-radius: 14px;
      font-size: 13px;
    }

    .remove-btn {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      cursor: pointer;
      font-weight: 900;
      color: var(--brown);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .remove-btn:hover { filter: brightness(0.98); }

    /* small screens: stack columns */
    @media (max-width: 720px) {
      .items-header { display: none; }
      .item-row {
        grid-template-columns: 1fr 1fr;
      }
      .item-row .remove-cell {
        grid-column: 1 / -1;
        text-align: right;
      }
    }

  </style>
</head>

<body>
  <div class="shell">
    <div class="app">

      <!-- Language Toggle -->
      <div class="lang-toggle">
        <span id="lang-en" class="active" onclick="setLang('en')">EN</span>
        <span id="lang-zh" onclick="setLang('zh')">‰∏≠Êñá</span>
      </div>

      <div class="header">
        <h1>üê∂ FriDoge ÂÜ∞Áãó</h1>
        <p id="subtitle">Your cozy fridge assistant</p>
        <div class="pill" id="pill">‚ú® Quick demo: fridge ‚Üí goal ‚Üí reaction</div>
      </div>

      <div class="layout">
        <!-- LEFT: inputs -->
        <div class="panel left-panel">

          <!-- People + Appetite -->
          <div class="section">
            <label id="label-people">üë• How many people?</label>
            <div class="grid-2">
              <div>
                <input id="people" type="number" min="1" step="1" value="1" />
                <div class="hint" id="hint-people">Set 1 for solo meal</div>
              </div>
              <div>
                <label id="label-appetite" style="margin-bottom:6px;">üçΩÔ∏è Appetite</label>
                <select id="appetite">
                  <option value="small">Small</option>
                  <option value="normal" selected>Normal</option>
                  <option value="big">Big</option>
                </select>
                <div class="hint" id="hint-appetite">Helps portion sizing</div>
              </div>
            </div>
          </div>

          <!-- Goal -->
          <div class="section">
            <label id="label-goal">üéØ Choose a style</label>
            <select id="goal">
              <option value="fat_loss" selected>Fat loss / ÂáèËÑÇ</option>
              <option value="muscle_gain">Muscle gain / Â¢ûËÇå</option>
              <option value="low_sugar">Low sugar / ÊéßÁ≥ñ</option>
              <option value="cheat_meal">Cheat meal / Ê¨∫È™óÈ§ê</option>
              <option value="whatever">Whatever / Èöè‰æøÂêÉ</option>
            </select>
            <div class="hint" id="hint-goal">FriDoge will adapt tone + recipe choices</div>
          </div>

          <!-- Fridge items -->
          <!-- <div class="section">
            <label id="label-items">ü•¶ What's in your fridge?</label>
            <textarea id="items" rows="4" placeholder="milk, eggs, broccoli"></textarea>
            <div class="hint" id="hint-items">Tip: separate items by commas</div>
          </div> -->

          <!-- Fridge items -->
          <div class="section">
            <label id="label-items">ü•¶ What's in your fridge?</label>

            <div class="items-toolbar">
              <button class="mini-btn" type="button" onclick="addItemRow()">
                ‚ûï Add item
              </button>
              <button class="mini-btn" type="button" onclick="clearItemsTable()">
                üßπ Clear items
              </button>
            </div>

            <div class="items-table" id="items-table">
              <div class="items-header">
                <div>Name</div>
                <div>Weight (g)</div>
                <div>Energy (kJ)</div>
                <div>Protein (g/100g)</div>
                <div>Carb (g/100g)</div>
                <div>Fat (g/100g)</div>
                <div>Photo</div>
                <div></div>
              </div>

              <div id="items-rows"></div>
            </div>

            <div class="hint" id="hint-items">
              Tip: add one food per row. Leave blank if unknown (will be None).
            </div>
          </div>


          <!-- Main request -->
          <div class="section">
            <label id="label-request">üí≠ What do you want today?</label>
            <textarea id="request" rows="3" placeholder="I want a healthy and easy meal today"></textarea>
          </div>

          <!-- Extra -->
          <div class="section">
            <label id="label-extra">üß© Personal needs (optional)</label>
            <textarea id="extra" rows="3" placeholder="e.g. no dairy, 15-min cooking, spicy, high protein, period-friendly..."></textarea>
            <div class="hint" id="hint-extra">Allergies / dislikes / time limit / cookware</div>
          </div>

          <div class="button-wrapper">
            <button id="ask-btn" onclick="send()">Ask FriDoge üêæ</button>
          </div>

          <div class="footer-note" id="footer-note">
            üê∂ Tip: later you can add cute images/illustrations without changing the logic.
          </div>
        </div>

        <!-- RIGHT: result -->
        <div class="panel right-panel">
          <div class="reaction-wrap">
            <div class="reaction-title">
              <h3 id="reaction-title">üßæ AI Reaction</h3>
              <div class="mini-btns">
                <button class="mini-btn" onclick="copyResult()">Copy</button>
                <button class="mini-btn" onclick="clearResult()">Clear</button>
              </div>
            </div>
            <div id="result" class="reaction">FriDoge is waiting for your fridge info üßä</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    let currentLang = "en";

    const textMap = {
      en: {
        subtitle: "Your cozy fridge assistant",
        pill: "‚ú® Quick demo: fridge ‚Üí goal ‚Üí reaction",
        people: "üë• How many people?",
        hintPeople: "Set 1 for solo meal",
        appetite: "üçΩÔ∏è Appetite",
        hintAppetite: "Helps portion sizing",
        goal: "üéØ Choose a style",
        hintGoal: "FriDoge will adapt tone + recipe choices",
        items: "ü•¶ What's in your fridge?",
        hintItems: "Tip: separate items by commas",
        request: "üí≠ What do you want today?",
        extra: "üß© Personal needs (optional)",
        hintExtra: "Allergies / dislikes / time limit / cookware",
        ask: "Ask FriDoge üêæ",
        thinking: "üê∂ FriDoge is thinking...",
        waiting: "FriDoge is waiting for your fridge info üßä",
        footer: "üê∂AI Dog is training...",
        reactionTitle: "üßæ AI Reaction",
        copied: "‚úÖ Copied!"
      },
      zh: {
        subtitle: "‰Ω†Ë¥¥ÂøÉÁöÑÂÜ∞ÁÆ±Â∞èÁÆ°ÂÆ∂",
        pill: "‚ú® Âø´ÈÄüÊºîÁ§∫ÔºöÂÜ∞ÁÆ± ‚Üí ÁõÆÊ†á ‚Üí ÂÜ∞ÁãóÂª∫ËÆÆ",
        people: "üë• Âá†‰∏™‰∫∫ÂêÉÔºü",
        hintPeople: "‰∏Ä‰∏™‰∫∫Â∞±Â°´ 1",
        appetite: "üçΩÔ∏è È£üÈáèÂ§ßÂ∞è",
        hintAppetite: "Áî®‰∫é‰º∞ÁÆó‰ªΩÈáè",
        goal: "üéØ ÈÄâÊã©È•ÆÈ£üÈ£éÊ†º",
        hintGoal: "ÂÜ∞Áãó‰ºöÊåâÁõÆÊ†áË∞ÉÊï¥ËØ≠Ê∞îÂíåÊé®Ëçê",
        items: "ü•¶ ÂÜ∞ÁÆ±ÈáåÊúâ‰ªÄ‰πàÔºü",
        hintItems: "ÊèêÁ§∫ÔºöÁî®ÈÄóÂè∑ÂàÜÈöîÈ£üÊùê",
        request: "üí≠ ‰Ω†‰ªäÂ§©ÊÉ≥Ë¶Å‰ªÄ‰πàÔºü",
        extra: "üß© ‰∏™ÊÄßÂåñÈúÄÊ±ÇÔºàÂèØÈÄâÔºâ",
        hintExtra: "ÂøåÂè£/ËøáÊïè/Êó∂Èó¥ÈôêÂà∂/Âé®ÂÖ∑/Âè£Âë≥Á≠â",
        ask: "ÈóÆÈóÆÂÜ∞Áãó üêæ",
        thinking: "üê∂ ÂÜ∞ÁãóÊ≠£Âú®ÊÄùËÄÉ‰∏≠...",
        waiting: "ÂÜ∞ÁãóÂú®Á≠â‰Ω†ÂëäËØâÊàëÂÜ∞ÁÆ±ÈáåÊúâ‰ªÄ‰πà üßä",
        footer: "üê∂ÂÜ∞ÁãóËøòÂú®ËÆ≠ÁªÉ‰∏≠...",
        reactionTitle: "üßæ ÂÜ∞ÁãóÂõûÂ§ç",
        copied: "‚úÖ Â∑≤Â§çÂà∂ÔºÅ"
      }
    };



    function setLang(lang) {
      currentLang = lang;

      document.getElementById("lang-en").classList.toggle("active", lang === "en");
      document.getElementById("lang-zh").classList.toggle("active", lang === "zh");

      document.getElementById("subtitle").innerText = textMap[lang].subtitle;
      document.getElementById("pill").innerText = textMap[lang].pill;

      document.getElementById("label-people").innerText = textMap[lang].people;
      document.getElementById("hint-people").innerText = textMap[lang].hintPeople;

      document.getElementById("label-appetite").innerText = textMap[lang].appetite;
      document.getElementById("hint-appetite").innerText = textMap[lang].hintAppetite;

      document.getElementById("label-goal").innerText = textMap[lang].goal;
      document.getElementById("hint-goal").innerText = textMap[lang].hintGoal;

      document.getElementById("label-items").innerText = textMap[lang].items;
      document.getElementById("hint-items").innerText = textMap[lang].hintItems;

      document.getElementById("label-request").innerText = textMap[lang].request;

      document.getElementById("label-extra").innerText = textMap[lang].extra;
      document.getElementById("hint-extra").innerText = textMap[lang].hintExtra;

      document.getElementById("ask-btn").innerText = textMap[lang].ask;
      document.getElementById("reaction-title").innerText = textMap[lang].reactionTitle;

      // ‰∏çÂº∫Ë°åË¶ÜÁõñÁî®Êà∑Â∑≤ÁªèÁîüÊàêÁöÑÁªìÊûúÔºõÂè™Âú®Á©∫Êó∂ËÆæÁΩÆ waiting
      const result = document.getElementById("result");
      if (!result.dataset.hasResult) {
        result.innerText = textMap[lang].waiting;
      }

      document.getElementById("footer-note").innerText = textMap[lang].footer;

      if (lang === "zh") {
        // document.getElementById("items").placeholder = "ÁâõÂ•∂, È∏°Ëõã, Ë•øÂÖ∞Ëä±";
        document.getElementById("request").placeholder = "ÊàëÊÉ≥ÂêÉÂæóÂÅ•Â∫∑‰∏ÄÁÇπÔºåÂÅöÊ≥ïÁÆÄÂçï";
        document.getElementById("extra").placeholder = "ÊØîÂ¶ÇÔºö‰∏çÂêÉ‰π≥Âà∂ÂìÅ„ÄÅ15ÂàÜÈíüÊêûÂÆö„ÄÅÊÉ≥ÂêÉËæ£„ÄÅÈ´òËõãÁôΩ„ÄÅÂß®Â¶àÂèãÂ•Ω...";
      } else {
        // document.getElementById("items").placeholder = "milk, eggs, broccoli";
        document.getElementById("request").placeholder = "I want a healthy and easy meal today";
        document.getElementById("extra").placeholder = "e.g. no dairy, 15-min cooking, spicy, high protein, period-friendly...";
      }
    }



    function clearResult() {
      const result = document.getElementById("result");
      result.dataset.hasResult = "";
      result.classList.remove("loading");
      result.innerText = textMap[currentLang].waiting;
    }



    async function copyResult() {
      const text = document.getElementById("result").innerText || "";
      try {
        await navigator.clipboard.writeText(text);
        // ÁÆÄÂçïÊèêÁ§∫Ôºö‰∏¥Êó∂ÊîπÊ†áÈ¢ò
        const t = document.getElementById("reaction-title");
        const old = t.innerText;
        t.innerText = textMap[currentLang].copied;
        setTimeout(() => (t.innerText = old), 900);
      } catch (e) {
        // ‰∏çÂº∫‰æùËµñ clipboard ÊùÉÈôê
        alert("Copy failed. Please select text and copy manually.");
      }
    }



    function addItemRow(prefill = {}) {
      const rows = document.getElementById("items-rows");

      const row = document.createElement("div");
      row.className = "item-row";

      row.innerHTML = `
        <input class="item-name" type="text" placeholder="e.g. chicken breast" value="${escapeHtml(prefill.name ?? "")}" />
        <input class="item-weight" type="number" min="0" step="any" placeholder="g" value="${prefill.weight_g ?? ""}" />
        <input class="item-energy" type="number" min="0" step="any" placeholder="kJ" value="${prefill.energy_kj ?? ""}" />
        <input class="item-protein" type="number" min="0" step="any" placeholder="g/100g" value="${prefill.protein_g_per_100g ?? ""}" />
        <input class="item-carb" type="number" min="0" step="any" placeholder="g/100g" value="${prefill.carb_g_per_100g ?? ""}" />
        <input class="item-fat" type="number" min="0" step="any" placeholder="g/100g" value="${prefill.fat_g_per_100g ?? ""}" />

        <div class="photo-cell">
          <button class="mini-btn" type="button" onclick="triggerUploadForRow(this)">üì∑ Upload</button>
          <input class="item-photo" type="file" accept="image/*" style="display:none" onchange="handlePhotoSelected(this)" />
          <div class="hint item-photo-status" style="margin-top:6px; font-size:11px;"></div>
        </div>

        <div class="remove-cell">
          <button class="remove-btn" type="button" title="Remove" onclick="this.closest('.item-row').remove()">‚úï</button>
        </div>
      `;

      rows.appendChild(row);
    }



    function triggerUploadForRow(btnEl) {
      const row = btnEl.closest(".item-row");
      const fileInput = row.querySelector(".item-photo");
      fileInput.click();
    }

    async function handlePhotoSelected(fileInputEl) {
      const row = fileInputEl.closest(".item-row");
      const file = fileInputEl.files?.[0];
      if (!file) return;

      const statusEl = row.querySelector(".item-photo-status");
      statusEl.innerText = currentLang === "zh" ? "Ê≠£Âú®ËØÜÂà´Ëê•ÂÖªÊàêÂàÜË°®..." : "Reading nutrition label...";

      try {
        const dataUrl = await readFileAsDataURL(file);
        // dataUrl example: "data:image/png;base64,AAAA..."
        const base64 = dataUrl.split(",")[1] || "";
        const mime = (dataUrl.split(";")[0] || "data:image/jpeg").replace("data:", "");

        const fallbackName = (row.querySelector(".item-name")?.value ?? "").trim();
        const fallbackWeight = row.querySelector(".item-weight")?.value ?? "";

        const API_BASE = "https://fri-doge.vercel.app";

        const res = await fetch(`${API_BASE}/api/nutrition`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            lang: currentLang,
            image_base64: base64,
            image_mime: mime,
            // ÂèØÈÄâÔºöÂ¶ÇÊûúÂõæÁâá‰∏çÊ∏ÖÊô∞ÔºåÁî®ÊâãÂ°´‰ø°ÊÅØ‰Ωú‰∏∫ hint
            hint: {
              name: fallbackName || null,
              weight_g: fallbackWeight ? Number(fallbackWeight) : null
            }
          })
        });

        const out = await res.json();
        if (!res.ok) {
          throw new Error(out?.error || "nutrition api failed");
        }

        // out.item is structured
        fillRowFromItem(row, out.item);

        statusEl.innerText = currentLang === "zh"
          ? `‚úÖ Â∑≤ËØÜÂà´Âπ∂ÂõûÂ°´ÔºàÁΩÆ‰ø°Â∫¶Ôºö${out.confidence ?? "?"}Ôºâ`
          : `‚úÖ Filled (confidence: ${out.confidence ?? "?"})`;
      } catch (e) {
        statusEl.innerText = currentLang === "zh"
          ? `‚ùå ËØÜÂà´Â§±Ë¥•Ôºö${e.message}`
          : `‚ùå Failed: ${e.message}`;
      } finally {
        // allow re-uploading same file
        fileInputEl.value = "";
      }
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error("file read error"));
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }

    function fillRowFromItem(row, item) {
      // Only fill if returned value is not null/undefined.
      // This prevents overwriting user manually-entered values.
      const setIf = (selector, val) => {
        if (val === null || val === undefined) return;
        const el = row.querySelector(selector);
        if (!el) return;
        el.value = String(val);
      };

      setIf(".item-name", item.name);
      setIf(".item-weight", item.weight_g);
      setIf(".item-energy", item.energy_kj);
      setIf(".item-protein", item.protein_g_per_100g);
      setIf(".item-carb", item.carb_g_per_100g);
      setIf(".item-fat", item.fat_g_per_100g);
    }



    function clearItemsTable() {
      document.getElementById("items-rows").innerHTML = "";
    }



    // Convert empty -> null (meaning "None"), and number -> Number
    function readNullableNumber(value) {
      const s = (value ?? "").toString().trim();
      if (!s) return null; // <-- None semantics
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }


    function readItemsFromTable() {
      const rows = Array.from(document.querySelectorAll("#items-rows .item-row"));
      const items = [];

      for (const r of rows) {
        const name = (r.querySelector(".item-name")?.value ?? "").trim();

        // If user adds an empty row, skip it
        const hasAnyField =
          name ||
          (r.querySelector(".item-weight")?.value ?? "").trim() ||
          (r.querySelector(".item-energy")?.value ?? "").trim() ||
          (r.querySelector(".item-protein")?.value ?? "").trim() ||
          (r.querySelector(".item-carb")?.value ?? "").trim() ||
          (r.querySelector(".item-fat")?.value ?? "").trim();

        if (!hasAnyField) continue;

        items.push({
          name: name || null, // None if not given
          weight_g: readNullableNumber(r.querySelector(".item-weight")?.value),
          energy_kj: readNullableNumber(r.querySelector(".item-energy")?.value),
          protein_g_per_100g: readNullableNumber(r.querySelector(".item-protein")?.value),
          carb_g_per_100g: readNullableNumber(r.querySelector(".item-carb")?.value),
          fat_g_per_100g: readNullableNumber(r.querySelector(".item-fat")?.value),
        });
      }

      return items;
    }


    
    // Small helper to avoid breaking HTML when prefilling strings
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }


    async function send() {
      // const items = document.getElementById("items").value
      //   .split(",")
      //   .map(i => i.trim())
      //   .filter(Boolean);
      const items = readItemsFromTable();

      const request = document.getElementById("request").value;
      const extra = document.getElementById("extra").value;

      const people = parseInt(document.getElementById("people").value || "1", 10);
      const appetite = document.getElementById("appetite").value;
      const goal = document.getElementById("goal").value;

      const result = document.getElementById("result");
      result.innerText = textMap[currentLang].thinking;
      result.classList.add("loading");

      const API_BASE = "https://fri-doge.vercel.app";


      try {
        const res = await fetch(`${API_BASE}/api/react`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            lang: currentLang,
            items,
            request,
            extra,
            people,
            appetite,
            goal
          })
        });

        const data = await res.json();
        result.classList.remove("loading");
        result.dataset.hasResult = "1";
        result.innerText = data.result || JSON.stringify(data, null, 2);
      } catch (err) {
        result.classList.remove("loading");
        result.dataset.hasResult = "1";
        result.innerText = (currentLang === "zh")
          ? "‚ùå ËØ∑Ê±ÇÂ§±Ë¥•ÔºöËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ API Âú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ„ÄÇ"
          : "‚ùå Request failed: please check network or API URL.";
      }
    }
  </script>
</body>
</html>
